# 第七章 多处理机MIMD

## 一、多处理机的概念、问题和硬件结构

### 1、多处理机的基本概念

两台以上处理机,共享I/O系统,机间经共享或高速通信网络通信，在统一操作系统控制下,协同求解大而复杂问题的计算机系统。

 MIMD,多指令流多数据流

 作业或任务级并行

```
Hadoop:  GFS  ----  HDFS  分布式系统
		MapReduce ---- 并行模型，支持java
		BigTable
```

### 2、 多处理机要解决的技术问题

1. 硬件结构上如何解决好处理机、存贮器模块及I/O子系统之间的互连。
2. 如何最大限度地开发系统的并行性,以实现多处理机的各级的全面并行。
3. 如何选择分割任务和子任务的大小, 即任务的粒子小 ，使并行度高， 而辅助开销小。
4.  如何协调好多处理机中各并行执行的任务和进程间的同步问题。
5. 如何将各个任务分配到一个或多个处理机上, 解决好处理机调度、任务调度和资源分配问题,防止死锁。
6. 一旦某个处理机发生故障,如何对系统进行重新组织而不使其瘫痪。

### 3、 多处理机要解决的技术问题

1. 多处理机的结构
2. 机间互连
3. 并行算法   ---  `MPI`
4. 并行语言
5. 编译支持
6. 操作系统支持

### 3、多处理机的硬件结构

1. 紧耦合和松耦合

2. 机间互连形式

   一般采用总线，唤醒互连、交叉开关、多端口存储器，蠕虫

3. 存储器的组织

#### 3.1、紧耦合和松耦合

##### 3.1.1、紧耦合

​		**紧耦合多处理机** ：通过共享主存来实现处理机间通信的，其通信速率受限于主存的频宽。但是,由于各处理机与主存经互连网络连接,系统中处理机数就受限于互连网络带宽及多台处理机同时访问主存发生冲突的概率。

松耦合多处理机:

2. 机间互连形式

3. 存储器的组织

 **（1）紧耦合多处理机**

​		就个处理机而言,有同构对称型和异构非对称型。

​		用于并行任务时,常采用同构对称型的紧耦合多处理机。

​		采用非对称IO互连,即连到一台处理机的设备不能被另外一台处理机直接访问。

**（2）紧耦合多处理机：构形**

![](F:\自考\计算机系统结构\img\2020-06-01_114036.jpg)

**（3）非对称I/O子系统的多处理机**

![](F:\自考\计算机系统结构\img\2020-06-01_115223.jpg)

**（4）采用冗余连接的非对称I/O子系统**

![](F:\自考\计算机系统结构\img\2020-06-01_115427.jpg)

##### 3.1.2、松耦合

1. 紧耦合和松耦合

   ​	紧耦合多处理机

   ​	**松耦合处理机**：每台处理机都有一个容量较大的局部存储器,用于存储经常用的指令和数据,以减少紧耦合系统中的访存主存冲突。不同处理机间通**通道互连/消息传递系统**来交换信息。粗粒度并行。

2. 机间互连形式

3. 存储器的组织

**（1）松耦合多处理机构形：非层次性和层次性**

- 通过消息传递系统的松耦合非层次型多处理机结构

![](F:\自考\计算机系统结构\img\2020-06-01_132811.jpg)

- 松耦合层次型总线式结构    Cm * 多处理机构

  ![](F:\自考\计算机系统结构\img\2020-06-01_133838.jpg)



#### 3.2 、机间互联形式

##### 3.2.1、机间互连：总线形式

​		多个处理机、存贮器模块和外围设备通过接口与公用总线相连,采用分时或多路转接技术传送。

​		其中,单总线方式结构简单、成本低,系统上增减模块方便,但对总线的失效敏感。而且,处理机数增加会增大访问总线冲突的概率而导致系统效率急剧下降。

​		虽然可以在处理机中设置局部存贮器和专用外围设备来减少访问总线的冲突,但这种单总线形式也只适用于处理机数较少 的场合。

​		IBM Stretch 和`UNIVAC Larg `多处理机采用的就是单总线方式。

**机间互连：总线形式的优化**

​		有两种办法可以用来提高总线形式的系统效率。

​		一种办法是,采用优质高频同轴电缆来提高总线的传输速率;进一步使用**光纤通信**,其信息速率可达`109~1010b/s`.

 		另一种办法是,采用**多总线方式**来减少访问总线的冲突概率。如美国的`Tandem-16`和`Pluribus` 就采用双总线方式来提供一定的总线冗余和增大系统总的信息传送率。日本的实验多处理机`EPOS`采用的是四总线方式。德国西门子公司的结构式多处理机`SMS`采用的是八总线方式。而上节介绍的Cm*多微处理机，则采用分级的多总线方式。

##### 3.2.2、机间连接：环形互连

令牌环（`TokenRing`）：标识，谁拿到令牌谁发数据，只有一个能发数据

##### 3.2.3、机间连接：交叉开关

![](F:\自考\计算机系统结构\img\2020-06-01_144617.jpg)

交叉开关结点开关的结构

用4 * 4的交叉开关模块构成

16 * 16的两级交叉开关网络

![](F:\自考\计算机系统结构\img\2020-06-01_145148.jpg)

##### 3.2.4多端口贮存器形式

![](F:\自考\计算机系统结构\img\2020-06-01_145656.jpg)

##### 3.2.5、开关枢纽结构形式：X-TREE多处理机

![](F:\自考\计算机系统结构\img\2020-06-01_150024.jpg)

#### 3.3、存储器的组织

 多处理机的主存一般都采用由多个模块构成的并行存储器。

 并行存储器的设计组织应尽量减少各处理机同时访问同一个存储模块引起的效率。

##### 3.3.1、m个模块低位交叉编址

![](F:\自考\计算机系统结构\img\2020-06-01_151642.jpg)

##### 3.3.2、m个模块高位交叉编址

![](F:\自考\计算机系统结构\img\2020-06-01_151958.jpg)

##### 3.3.3、本地存储的概念

![](F:\自考\计算机系统结构\img\2020-06-01_152046.jpg)

##### 3.3.4、多处理机的二维并行存贮器构形

![](F:\自考\计算机系统结构\img\2020-06-01_152314.jpg)

## 二、紧耦合多处理机多Cache 的一致性问题

### 1、 Cache一致性分析

- 有两个处理器（A和B）读写引起的Cache一致性问题

| 时间    事件        | CPU A Cache内容 | CPU B Cache 内容 | X单元存储器内容 |
| ------------------- | --------------- | ---------------- | --------------- |
| 0                   |                 |                  | 1               |
| 1   CPU   A读X      | 1               |                  | 1               |
| 2   CPU   B读X      | 1               | 1                | 1               |
| 3   CPU   A将0存入X | 0               | 1                | 0               |

### 2、解决Cache一致性冲突的方法

##### 限制功能

禁止进程迁移、写直法

##### 硬件方法

监听法：写更新（播写法）、写作废

目录法

##### 软件方法

- 写更新协议（播写法）

  当一个处理器对某数据项进行写入时，通过广播使其他Cache中所有对应于该数据项的副本进行更新。

  | 时间              | 事件              | CPU A Cache内容 | CPU B Cache 内容 | X单元存储器内容 |
  | ----------------- | ----------------- | --------------- | ---------------- | --------------- |
  |                   |                   |                 |                  | 0               |
  | CPU A 读X         | Cache失效         | 0               |                  | 0               |
  | CPU B 读X         | Cache失效         | 0               | 0                | 0               |
  | CPU A将1写入单元X | 对单元X进行写广播 | 1               | 1                | 1               |
  | CPU B 读X         |                   | 1               | 1                | 1               |

- 写作废

  在处理器对某个数据项进行写入之前，保证他拥有对该数据项的唯一访问权。（作废其他副本）

  | 时间              | 事件      | CPU A Cache内容 | CPU B Cache 内容 | X单元存储器内容 |
  | ----------------- | --------- | --------------- | ---------------- | --------------- |
  |                   |           |                 |                  | 0               |
  | CPU A 读X         | Cache失效 | 0               |                  | 0               |
  | CPU B 读X         | Cache失效 | 0               | 0                | 0               |
  | CPU A将1写入单元X | 作废X单元 | 1               |                  | 0 ----> 1       |
  | CPU B 读X         | Cache失效 | 1               | 1                | 1               |

- 目录法

  ​		一种是**全映像目录表法**。表中每项有N个标志位对应于多处理机中全部N台处理机的Cache 系统中全部Cache 均可同时存有同一个信息块的副本。不过,这样的目录表很庞大，硬件及控制均较复杂。

  ​		另一种是**有限目录表法**。表中每项的标志位少于N个。因此,限制了一个数据块在各Cache中能存放的副本数目。这两种目录表都是集中地存入在共享的主存之中,因此需要由主存向各处理机广播。

  ​		 第三种是**链式目录表法**，它把目录分散存放在各个Cache中,主存只存有一个指针,指向一台处理机。要查找所有放有同一个信息块的Cache 时,先找到一台处理机的Cache ，然后顺链逐台查找,直到找到目录表中的指针为空时为止。

- 软件方法

   以软件为基础解决Cache 一致性的作法,主要优点是可以减少硬件的复杂性,降低对互连网络通信量的要求,因而性能价格比可以较高,比较适用于处理机数多的多处理机，但应当指出的是,现在以软件为基础的办法虽已提出了好几种方案,但由于可靠性及编译程序的编写困难,都还没有真正在商品化多处理机上使用,只在某些试验性系统上使用,如伊利诺大学的Cedar 机。

## 三、多处理机的并行性和性能

### 1、并行算法

#### （1）多处理机的并行性

 并行性既存在于指令内部,也存在于指令外部。

 必须利用算法、程序设计语言、编译、操作系统以及指令、硬件等多种途径来开拓。

#### （2） 并行算法的分类

- 按运算基本对象,数值型、非数值型
-  按并行进程间的操作顺序,同步型、异步型和独立型
- 按计算任务大小,细粒度、中粒度、粗粒度
- 按并行进程是否相同，同构性(SIMD)，异构性（MIMD）

#### （3） 并行算法的研究思路

 将大的程序分解成可由足够多的并行处理过程(进程、任务、程序段)

 每个过程认为是一个结点。关联关系用结点组成的树描述

 算法必须适应具体的计算机结构。串行处理机上习惯采用的循环和迭代算法往往不适合于多处理机,而采用直节解法有时反倒能揭示更多的并行性。

#### （4） 并行分析参数

 P表示可并行处理的处理机数目

`Tp`表示P台处理机运算的级数,即树高

 加速比Sp,表示单处理机顺序运算级数与P台处理机并行运算`Tp`之比

 `Ep`表示P台处理机的设备利用率,`Ep=Sp/P`

#### （5）案例1分析

例如，`E1 = a + bx + cx^2 + dx^3`

利用霍纳（Horner）法可得到`E1 = a+x(b+x(c+x(d)))`

![](F:\自考\计算机系统结构\img\2020-06-01_160159.jpg)

#### （5） 案例2分析

2

 首先从算术表达式的最直接形式出发,利用交换律把相同的运算集中在一起。再利用结合律把参加这些运算的操作数(称原子)配对,尽可能并行运算,从而组成树高最小的子树。最后,再把这些子树结合起来。例如,给定表达式为

 `E2 = a + (c+def+g) + h`

需7级运算,利用交换律和结合律改写为

`E2 =(a+h)+ b(c+g)+def)`

![](F:\自考\计算机系统结构\img\2020-06-02_214317.jpg)

优化

`E2=(a+h)+(bc+bg)+bdef`,利用分配律进一步降低树高,在恰当平衡各子树的级数的情况下,往往能收到较好的效果。

![](F:\自考\计算机系统结构\img\2020-06-02_214446.jpg)

### 2、程序并行性分析

假定一个程序包含`P1、P2、…、Pi、…、Pj、.... 、Pn`等n个程序段,其书写的顺序反映了该程序正常执行的顺序，为了便于了便于分析,设`Pi`,和`Pj`程序段都是一条语句,`Pi`在`Pj`之前执行，且只讨论P和P之间数据的直接相关关系。实际上，`Pi`和`Pj`即使表面上没有数据相关,也可能通过它们之间的其他语句形成间接的数据相关关系。

#### （1）数据相关

 如果P的左部变量在P的右部变量集内，且`Pj`必须取出`Pi`运算的结果来作为操作数,就称`Pj`"数据相关"。 例如

`Pi          A = B + D`

`Pj         C = A * E`

 相当于流水中发生的“先写后读”相关。

```
顺序串行运行的正确结果应当是
Pi    A新=B原+D原
Pj    C新=A新*E原=(B原+D原)*E原
如果让Pi和Pj并行,
Pj的C新=A原*E原,显然不是应有的结果,
因此Pi和Pj是不能并行的。
```

#### （2）数据反相关

 如果P的左部变量在P的右部变量集内,且当Pi未取用其变量的值之前,是不允许被P所改变的，就称Pi"数据反相关”于例如

 `Pi    C = A + E`

`Pj     A = B + D`

 相当于流水中发生的“先读后写"反相关。

```

顺序串行运行的正确结果应是
Pi   C新=A原+E原
Pj   A新=B原+D原
可以看出,当Pi与Pj并行时,只有硬件上能保证Pi对相关单元A先读出,就能得到结果。
```

#### （3） 数据输出相关

 如果的左部变量也是`Pj`的左部变量,且`Pj`存入其算得的值必须在`Pj`存入之后,则称`Pj`“数据输出相关”于Pi 。例如

`Pi      A =B+D`

`Pj     A =C+E`

 相当于流水中发生的“先写后写”相关

```

按原执行顺序
A新应为c+E
可以看出,只要同步能保证Pi的先写入A之后,Pj的再写入A,这两个程序段才可以并行。
```

#### （4）互为输出变量

 如果两个程序段的输入变量互为输变量，同时具有“先写后读”和“先读后写”两种相关，以交换数据为目的,则两者必须并行执行,既不能顺序串行，也不能交换串行。 例如,两语句的左、右变量互相交换

`Pi     A =B`

`Pj     B =A`

#### （5）无数据相关

如果两个程序段之间不存在任何一种数据相关,即无共同变量或共同变量都只出现在右边的源操作数,则两个程序段可以无条件地并行执行,也可以串行或交换串行。例如

 `Pi      A =B+C`

 `Pj      D=B*E`

### 3、并行语言与性能

####  （1）并行语言与并行编译

 并行算法需要用并行程序来实现。

**并行程序设计语言的基本要求：** 使程序员在其程序中灵活、方便地表示出各类并行性，能在各种并行/向量计算机系统中高效地实现。

**实现方法**

1. 普通顺序性语言上进行扩充,增加能明确表示并行进程的成分

2. 设计全新的并行程序设计语言

#### （2） 并行任务的派生与汇合

并行任务的派生是使一个任务在执行的同时,派生出可与它并行执行的其他一个或多个任务,分配给不同的的处理机完成。 这些任务可以是相同的,也可以是不同的,执行时间也可以各不相同。

 等它们全部完成后,再汇合起来进行后续的单任务或新的并行任务。

 如果是并行任务,则继续派生,再汇合。直到全部结束。

#### （3） 多处理机V并行处理机

虽然多处理机中的每一个处理机与并行处理机中的每个处理单元看起来工作一样,但处理方式不一样。

1. 多处理机是异步处理,并行处理机是同步处理

2. 多处理机数目对程序编写没有影响,由操作系统控制

#### （4） 多处理机性能

- 理想情况:

   随着处理机数N的增加,性能线性增长

-  实际情况:

  1. 存在不可并行情况

  2. 存在辅助开销

     并行性检测

     并行任务的派生和汇合

     处理机间的通信传输、同步、系统控制和调度

- 任务粒度：

  任务切割

  处理机机数

程序用于有效计算的执行时间E

处理机间通信等辅助开销时间C

E、C比值较大时,并行性才有好处。

综合利用并行算法、并行语言、并行程序设计来减少额外开销

## 四、多处理机的操作系统

###  1、多处理机操作系统的难度

1. 处理机的分配和进程调度
2. 进程间的同步
3. 进程间的通信
4. 存储系统的管理
5. 文件系统的管理
6. 某处理机或设备故障时系统的重组

### 2、 多处理机操作系统应具备的特点

1. 程序执行的并行性
2. 操作系统功能的分布性
3. 机间通信与同步性
4. 系统的容错性

### 3、 多处理机操作系统的分类

1. 主从型
2. 各自独立型
3. 浮动型

#### （1）  主从型

 主从型管理程序只在一个指定的处理机(主处理机）上运行。该主处理机可以是专门的执行管理功能的控制，也可以是与其他从处理机相同的通用机,除执行管理，也能作其他方面的应用。

由于主处理机是负责管理系统中所有其他处理机的状态及其工作的分配,只把从处理机是一个可调度的资源,实现对整个系统的集中控制,称为**集中控制或专门控制方式**。

 从处理机是通过访管指令或自陷(Trap)软件来中断请求主处理机服务的。

#### （2） 各自独立型

与主从型不同,各自独立型将控制功能分散给多台处理机，共同完成对整个系统的控制工作。

 每台处理机都有一个独立的管理程序(操作系统的内核）在运行,即每台处理机都有一个内核的副本,按自身的需要及分配给它的程序需要来执行各种管理功能。由于多台处理机执行管理程序,要求管理程序必须是可再入的，或对多台处理机提供专用的管理程序副本。

#### （3）浮动型

 浮动型操作系统是界于主从型和各自独立型之间的一种折衷方式,其管理程序可以在处理机之间浮动。

在一段较长的时间里指定某一台处理机为控制处理机,但是具体指定哪一台处理机以及担任多长时间控制都是不固定的。主控制程序可以从一台处理机转到另一台处理机,其他处理机中可以同时有多台处理机执行同一个管理服务子程序。

 因此,多数管理程序必须是可再入的。由于同一个时间里可以有多台处理机处于管态,有可能发生访问表格和数据集的冲突,一般采用互斥访问方法解决。

## 五、多处理机的发展

