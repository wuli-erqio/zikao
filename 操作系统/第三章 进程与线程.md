# 第三章 进程与线程

## 第一节 多道程序设计

### 一、程序的顺序执行

#### 1、顺序程序设计

* 程序在一个时间上按严格次序前后相继的操作序列
* 计算机也是以顺序方式工作的：计算机一次执行一条指令、对内存一次访问一个字节或字，对外部设备一次传送一个数据块等
* 我们把一个具有独立功能的程序独占处理器直到得到最终结果的过程称为程序的顺序执行

#### 2、程序的顺序执行的特点

1. 顺序性
   * 程序所规定的动作在机器上严格的按顺序执行

2. 封闭性
   * 程序运行后，其计算结果只取决于程序自身，程序执行得到的最终结果由给定的初始条件决定，不受外界因素影响

3. 程序执行结果的确定性
   * 程序执行的结果与其执行的速度无关

4. 程序执行结果的可在现性
   * 如果程序在不同的时间执行，只要初始条件相同，则结果就会相同

### 二、程序的并发执行

* 所谓并发执行，是指两个或者两个以上程序在计算机系统中，同时处于已开始执行且尚未结束的状态
* 能够参与并发执行的程序称为并发程序
* 并发程序的执行和程序顺序执行的特征不同

#### 1、并发执行的特征如下

1. 在执行期间并发程序相互制约

2. 程序与计算机不在一一对应。允许多个程序共享一个程序段

3. 并发程序的执行结果不可在现

   并发程序与其执行的相对速度以及并发执行的多道程序之间的相互关系有关

4. 程序的并发执行和程序的并行执行

   程序的并发执行是宏观上的同时，微观是顺序。并行则是微观上是同时的

#### 2、多道程序设计技术引入

a)  顺序环境下

![](F:\自考\操作系统\img\2020-05-18_162034.jpg)

CPU的利用率= 40/80=50%

`DEV1`的利用率=15/80=18.75%

`DEV2`的利用率=25/80=31.25%

b) 并发环境

![](F:\自考\操作系统\img\FastStoneEditor.jpg)

CPU的利用率= 40/45=89%

`DEV1`的利用率=15/45=33%

`DEV2`的利用率=25/45=56%

#### 3、多道程序设计环境特点

* 多道程序设计：就是允许多个程序同进入内存并运行。根本目的是提高整个系统的效率。
* 吞吐量：指单位时间内系统所处理进程的道数，是衡量系统效率的尺度。

1. 独立性
   * 在多道环境下执行的每道程序都是逻辑上独立的，且执行速度与其他程序无关，执行的气质时间也是独立的

2. 随机性
   * 程序和数据的输入与执行开始时间都是随机的

3. 资源共享性

#### 4、多道程序设计环境缺陷

1. 可能延迟程序的执行时间
2. 系统效率的提高有一定限度

![](F:\自考\操作系统\img\FastStoneEditor.jpg)

## 第二节 进程

### 一、进程的定义

进程是具有一定独立功能的程序在某个数据集合上的一次运行活动，是系统进行资源分配和调度的一个独立单位

分为：系统进程和用户进程

#### 1、进程与程序的联系和区别

* 进程和程序的联系
  * 程序是构成进程的组成部分之一，一个进程的运行目标是执行它所对应是程序
  * 进程=程序+数据+进程控制块

* 进程和程序的区别
  * 程序是静态的，进程是动态的
  * 二者是多对多的关系

#### 2、可再入程序

* 一个能够被多个用户同时调用的程序称作是“可再入”程序。
* 可再入程序必须是纯代码，程序在执行过程中不会修改自己的代码，必须与数据区隔离。
* 比如：操作系统、编译程序，他们能同时被不同的用户调用而形成不同的进程。

#### 3、进程的特征

1. 并发性
2. 动态性
3. 独立性
4. 交往性
5. 异步性
6. 结构性        程序+数据+进程控制块(PCB)

### 二、进程的状态与转换

#### 1、三状态进程模型

1. 运行状态
2. 就绪状态
3. 等待(阻塞)状态

* 状态转换
  1. 就绪  -》 运行
  2. 运行  -》 就绪 
  3. 运行 -》 等待
  4. 等待 -》 就绪

![](F:\自考\操作系统\img\2020-05-18_172223.jpg)

#### 2、五状态进程模型

1. 运行状态

2. 就绪状态

3. 阻塞状态

4. 创建状态

5. 结束状态

   ![](F:\自考\操作系统\img\2020-05-18_172943.jpg)

#### 3、七状态进程模型

![](F:\自考\操作系统\img\2020-05-18_173236.jpg)

### 三、进程控制块

* 为了便于系统控制和描述进程的活动过程，在操作系统核心中定义了一个专门的数据结构，称为PCB

PCB的作用：

* 描述进程的基本情况以及进程的运行变化过程
* PCB是进程存在的唯一标识，当系统创建一个进程时，为进程设置一个PCB，在利用PCB对进程进行控制和管理。撤销进程时，系统收回PCB，进程也随之消亡

#### 1、PCB的内容

1. 调度信息

   供进程调度时使用，包括进程名、进程号、地址空间信息、优先级、当前状态、资源清单、“家族”关系、消息队列指针、进程队列指针和当前打开文件等。

2. 现场信息

   刻画了进程的运行情况，主要是CPU寄存器的信息，如程序状态字、时钟、界地址寄存器等。当程序中断时，需要保存现场信息。

#### 2、进程的组成

进程是由程序、数据和进程控制块组成

PCB 是 “灵魂”

程序和数据是 “躯体”

#### 3、PCB阻止

1. 线性方式
2. 索引方式
3. 链接方式

![](F:\自考\操作系统\img\2020-05-18_175533.jpg)

![](F:\自考\操作系统\img\2020-05-18_175754.jpg)

#### 4、进程的队列

1. 就绪队列           1个或多个
2. 等待队列            多个
3. 运行队列             根据`cpu`

![](F:\自考\操作系统\img\2020-05-18_175937.jpg)

#### 5、进程队列的组成

* 进程队列实际是PCB的链接，链接分为：单向链表和双向链表。
* 出队：一个进程从所在队列退出。（也存在三种情况）
* 入队：一个进程排入到指定队列。
  * 从队首入队成为新的队首进程。
  * 从队尾入队成为新的队尾进程。
  * 插入到队列中某两个进程之间。
* 插队：一个进程插入到某个进程队列的指定位置。

### 四、进程控制

进程控制：

* 对进程整个生命周期中各种状态之间的转换进行控制。

* 由原语实现

原语：

就是由若干条指令组成，用于完成一定功能的一个过程，是一个不可分割的基本单位，即原语在执行过程中不允许被中断。原子操作在系统态下执行，常驻内存。

#### 1、进程控制原语

1. 创建原语
2. 撤销原语
3. 阻塞原语
4. 唤醒原语

##### (1) 创建原语

* 一个进程可以使用创建原语创建一个新的进程，前者称为父进程，后者成为子进程，子进程由可以创建新的进程，从而形成一个进程家族

* 主要任务：创建进程控制块PCB

* 过程： 先申请一个空闲PCB，然后将有关信息填入PCB,置进程状态就为就绪状态，插入就绪队列

##### (2) 撤销原语

* 当一个进程完成任务后，就应当撤销它，以便及时释放它所占用的资源
* 撤销的实质：撤销进程控制块PCB
* 过程：找到要被撤销进程的PCB, 将它从所在队列中消去，撤销属于该进程的一切“子进程”，释放所占全部资源，并消去被撤销进程的PCB。

##### (3) 阻塞原语

* 若某个进程在执行过程中需要I/O操作，则该进程调用阻塞原语将其从运行状态转换为阻塞状态
* 过程：产生中断，把处理器的当前状态保存在PCB的现场信息中，当前进程置为等待态，插入等待队列。

##### (4) 唤醒原语

* 一个进程因为等待某事件的发生而处于等待状态，当该事件发生后，就用唤醒原语将其转为就绪状态
* 过程：在等待队列中找到该进程，将进程的当前状态置为就绪状态，然后将它从等待队列中撤出并插入到就绪队列中排队，等待调度执行。

## 第三节 线程

### 一、线程的基本单位

进程的属性：

* 一个可拥有资源的独立单位
* 可独立调度和分派的基本单位

程序并发执行所需要付出的时空开销：

* 创建进程发开销
  * 内存空间、I/O设备、PCB

* 撤销进程的开销
  * 对其资源做回收

* 进程切换的开销
  * 保留CPU环境，设置新进程CPU环境

```
这些开销，限制了系统中进程的数目，进程切换也不宜频繁，限制了并发程度的进一步提高
```

引入线程的目的：

* 引入线程是为了使用多个进程并发执行
* 引入线程是为了减少程序并发执行时所付出的时空开销

##### 1、什么时线程

* 在引入线程的操作系统中，线程是进程中的一个实体，是处理器调度和分配的基本单位
* 一个线程可以创建和撤销另一个线程；同一个进程中的多个线程可以并发执行。
* 线程基本上不拥有系统资源，只拥有少量在运行中必不可少的资源，但他可与同属一个进程的其他线程共享进程所拥有的全部资源。

![](F:\自考\操作系统\img\2020-05-18_210922.jpg)

##### 2、线程的属性

1. 每个线程都有一个唯一的标识和一张线程描述表
2. 不同的线程可以执行相同的程序
3. 同一个进程中的各个线程共享该进程的内存地址空间
4. 线程是处理器的独立调度单位，多个线程可以并发执行
5. 一个线程具有生命周期，经历等待、就绪、运行等状态变化

##### 3、引入线程的好处

1. 创建一个新线程花费事件少
2. 线程之间的切换花费事件少
3. 线程之间通信无需调用内核，不需要额外的通信机制，使通信简单、信息传递速度快。

### 二、进程和线程的比较

1. 调度
2. 并发性
3. 拥有资源
4. 系统开销

##### 1、调度

* 线程作为调度的基本单位，同进程中线程切换不引起进程切换，当不同进程的线程切换时才引起进程切换

##### 2、并发性

* 一个进程间的多个线程可并发，不同进程的多个线程也可以并发执行。

##### 3、拥有资源

* 线程仅拥有隶属进程的资源；进程时拥有资源的独立单位

##### 4、系统开销

* 线程低，进程高。

### 三、线程实现机制

##### 1、用户级线程

* 仅存在于用户空间，由用户层中的线程库提供对线程的创建、撤销、切换，以及线程之间的同步于通信等的支持，而无需内核的支持

##### 2、内核级线程

​		由OS直接支持，更灵活，方便

##### 3、混合方式

##### 4、实例：`pthread`线程包

![](F:\自考\操作系统\img\2020-05-18_222851.jpg)

## 第四节 进程调度

### 一、概述

##### 1、进程调度的主要功能

* 记录系统中所有进程的执行状况
* 根据一定的调度算法，从就绪队列中选出一个进程，准备把处理器分配给它
* 分配处理器

##### 2、进程调度的时机

* 正在执行的进程运行完毕
* 正在执行的进程由于某种错误而终止运行
* 时间片完
* 正在执行的进程调用阻塞原语将自己阻塞起来
* 创建了新的进程
* 正在执行的进程调用了唤醒原语操作激活了等待资源的进程

处理器的调度方式：非抢占式和抢占式

1. 非抢占式

   一旦把处理机分配给某进程后，就一直让它运行下去，绝不会以为时钟中断，或任何其他原因，去抢占该正在运行进程的处理机，直至该进程完成，或发生某事件而被阻塞时，才把处理机分配给其他进程。

2. 抢占式

   允许调度程序根据某种原则，去暂停某个正在执行的进程，将已分配给该进程的处理机，重新分配给另一进程

   抢占方式能满足实时任务的需求。但抢占方式比较复杂，所需付出总开销也比较大。

### 二、调度算法设计原则

#### 1、 进程行为

​			I/O密集型和计算密集型

#### 2、系统分类

​			批处理、交互式、实时系统

#### 3、调度算法设计原则

​			共同目标：资源利用率高、公平、平衡、强制执行策略

​			批处理目标：平均周期时间短、系统吞吐量高

​			处理即利用率好

​			分时系统目标：响应时间快、均衡性

​			实时系统目标：截至时间的保证、可预测性

### 三、进程调度算法

1. 先来先服务
2. 最短进程优先
3. 最短剩余时间优先算法
4. 最高响应比优先算法
5. 轮转算法
6. 最高优先级算法
7. 多级反馈队列算法

#### 1、先来先服务

* 算法思想：总是把处理机分配给最先进入到就绪队列的进程，一个进程一旦分的处理机，便执行下去直到该进程完成或阻塞时，才释放处理机

* 优点：实现简单

* 缺点：没有考虑进程的优先级

* 举例：

  ![](F:\自考\操作系统\img\2020-05-18_233024.jpg)

#### 2、最短进程优先

* 算法思想：该算法从就绪队列中选出“下一个CPU执行期”最短的进程，为之分配处理机

* 优点：所有进程都同时可运行时算法最优

* 举例

  ![](F:\自考\操作系统\img\2020-05-18_233947.jpg)

#### 3、最短剩余时间优先算法

* 算法思想：总是选择剩余时间最短的那个进行运行。当一个新的进程到达时，其整个事件同当前的剩余时间做比较，如果新进程事件更少，则当前进程被挂起，运行新进程

#### 4、最高响应比优先算法

![](F:\自考\操作系统\img\2020-05-18_234919.jpg)

* 算法思想：总是优先调度响应比最大的进程

* 性能：先来先服务和最短进程优先算法的折中

* 举例：

  ![](F:\自考\操作系统\img\2020-05-18_235224.jpg)

  ![](F:\自考\操作系统\img\2020-05-18_235447.jpg)

  ![](F:\自考\操作系统\img\2020-05-18_235625.jpg)

  ```
  周转时间 = 完成时间 - 到达时间
  ```

  

#### 5、轮转算法

* 算法思想：最早来自于分时系统。将处理器的处理时间划分成一个个是啊见片，就绪队列中的诸进程轮流运行一个时间片，当时间片结束时就强迫运行进程让出处理器，该进程进入就绪队列，等待下次调用

* 影响时间片设置的因素

  * 系统响应时间

  * =就绪进程数目

  * 计算机的处理能力

    小结：时间片设的太短，胆汁过多的进程切换；太长，响应时间边长。合理的时间片`20~50ms`

#### 6、最高优先级算法

* 算法思想：
  * 为每个进程设立一个优先级，每次将处理器分配给具有最高优先级的就绪进程
  * 可以保证紧迫性进程优先运行

#### 7、多级反馈队列算法

* 算法思想： 结合了先进先出、时间片轮转、可抢占式最高优先级调度算法
* 算法思想要点：
  * 被调度队列的设置
  * 在同一个队列的调度原则
  * 在不同调度队列之间的调度原则
  * 进程优先级的调整原则

![](F:\自考\操作系统\img\2020-05-19_000852.jpg)

## 第五节 系统内核

### 一、内核的概念

内核的概念：

​        为了提高系统的运行效率、保护系统的关键部分不被破坏，一般把操作系统中提供支持系统运行的各种基本操作和基础功能的一组程序模块集中安排，形成一个操作系统的核心，称为系统核心或系统内核，简称内核。

### 二、内核的位置

​       内核本身不是进程，是系统进程和用户进程赖以活动的基础，一般嫩和常驻内存，操作系统其他部分则根据需要调进或调出内存。

### 三、内核的功能

1. 中断处理程序
2. 进程同步与互斥
3. 进程调度
4. 进程控制与通信
5. 存储管理
6. 始终管理

```
内核的各种功能通过执行原语操作来实现
```

